<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://www.micjoyce.com').hostname,
    root: '/',
    scheme: 'Mist',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"right","Muse | Mist":320,"display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="wrk 是一个很简单的 http 性能测试工具. 也可以叫做 http benchmark 工具. 只有一个命令行, 就能做很多基本的 http 性能测试">
<meta property="og:type" content="article">
<meta property="og:title" content="如何使用 wrk 进行性能压测">
<meta property="og:url" content="https://www.micjoyce.com/2019/02/03/wrk/index.html">
<meta property="og:site_name" content="Micjoyce&#39;s Blog">
<meta property="og:description" content="wrk 是一个很简单的 http 性能测试工具. 也可以叫做 http benchmark 工具. 只有一个命令行, 就能做很多基本的 http 性能测试">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-02-03T14:20:54.000Z">
<meta property="article:modified_time" content="2020-11-22T07:09:02.064Z">
<meta property="article:author" content="Micjoyce">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="性能测试">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://www.micjoyce.com/2019/02/03/wrk/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>如何使用 wrk 进行性能压测 | Micjoyce's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Micjoyce's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.micjoyce.com/2019/02/03/wrk/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.png">
      <meta itemprop="name" content="Micjoyce">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Micjoyce's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          如何使用 wrk 进行性能压测
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-03 22:20:54" itemprop="dateCreated datePublished" datetime="2019-02-03T22:20:54+08:00">2019-02-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-11-22 15:09:02" itemprop="dateModified" datetime="2020-11-22T15:09:02+08:00">2020-11-22</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2019/02/03/wrk/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/03/wrk/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>wrk 是一个很简单的 http 性能测试工具. 也可以叫做 http benchmark 工具. 只有一个命令行, 就能做很多基本的 http 性能测试</p>
<a id="more"></a>
<p>wrk的代码在 github 上. <a target="_blank" rel="noopener" href="https://github.com/wg/wrk">https://github.com/wg/wrk</a></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="mac"><a href="#mac" class="headerlink" title="mac"></a>mac</h3><p><code>brew install wrk</code></p>
<h3 id="Ubuntu-Debian-clean-box"><a href="#Ubuntu-Debian-clean-box" class="headerlink" title="Ubuntu/Debian (clean box)"></a>Ubuntu/Debian (clean box)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install build-essential libssl-dev git -y</span><br><span class="line">git clone https://github.com/wg/wrk.git wrk</span><br><span class="line">cd wrk</span><br><span class="line">sudo make</span><br><span class="line"><span class="meta">#</span><span class="bash"> move the executable to somewhere <span class="keyword">in</span> your PATH, ex:</span></span><br><span class="line">sudo cp wrk /usr/local/bin</span><br></pre></td></tr></table></figure>

<h3 id="CentOS-RedHat-Fedora"><a href="#CentOS-RedHat-Fedora" class="headerlink" title="CentOS / RedHat / Fedora"></a>CentOS / RedHat / Fedora</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo yum groupinstall &#x27;Development Tools&#x27;</span><br><span class="line">sudo yum install -y openssl-devel git </span><br><span class="line">git clone https://github.com/wg/wrk.git wrk</span><br><span class="line">cd wrk</span><br><span class="line">make</span><br><span class="line"><span class="meta">#</span><span class="bash"> move the executable to somewhere <span class="keyword">in</span> your PATH</span></span><br><span class="line">sudo cp wrk /somewhere/in/your/PATH</span><br></pre></td></tr></table></figure>

<h2 id="命令参数"><a href="#命令参数" class="headerlink" title="命令参数"></a>命令参数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">用法: wrk &lt;options&gt; &lt;url&gt;</span><br><span class="line">  Options:</span><br><span class="line">    -c, --connections &lt;N&gt;  Connections to keep open</span><br><span class="line">                            打开的连接数</span><br><span class="line">    -d, --duration    &lt;T&gt;  Duration of test</span><br><span class="line">                            持续时间，时间越长越准确</span><br><span class="line">    -t, --threads     &lt;N&gt;  Number of threads to use</span><br><span class="line">                            开启的进程数</span><br><span class="line">    -s, --script      &lt;S&gt;  Load Lua script file</span><br><span class="line">                            Lua脚本</span><br><span class="line">    -H, --header      &lt;H&gt;  Add header to request</span><br><span class="line">                            添加请求的header</span><br><span class="line">        --latency          Print latency statistics</span><br><span class="line">                            打印响应分布的统计</span><br><span class="line">        --timeout     &lt;T&gt;  Socket&#x2F;request timeout</span><br><span class="line">                            设置响应超时(2s, 2m, 2h)</span><br><span class="line">                            wrk 默认超时时间是1s</span><br><span class="line">    -v, --version          Print version details</span><br><span class="line">                            答应wrk版本信息</span><br><span class="line">  Numeric arguments may include a SI unit (1k, 1M, 1G)</span><br><span class="line">  Time arguments may include a time unit (2s, 2m, 2h)</span><br></pre></td></tr></table></figure>

<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p><code>wrk -t12 -c400 -d30s --latency  http://127.0.0.1:8000</code></p>
<blockquote>
<p>上面这句话的意思为：12个进程模拟400个连接，持续时间为30秒，并且打印出响应时间的分布</p>
</blockquote>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Thread Stats   Avg      Stdev     Max   +&#x2F;- Stdev</span><br><span class="line">    Latency    42.10ms   98.36ms   2.00s    98.33%</span><br><span class="line">    Req&#x2F;Sec     1.06k   284.48     4.20k    74.23%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%   26.65ms</span><br><span class="line">     75%   41.39ms</span><br><span class="line">     90%   62.64ms</span><br><span class="line">     99%  374.95ms</span><br><span class="line">  376093 requests in 30.07s, 60.62MB read</span><br><span class="line">  Socket errors: connect 0, read 0, write 0, timeout 81</span><br><span class="line">Requests&#x2F;sec:  12508.83</span><br><span class="line">Transfer&#x2F;sec:      2.02MB</span><br></pre></td></tr></table></figure>

<p>解释：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">进程状态        平均值     标准差     最大值   正负一个标准差占比</span><br><span class="line">    响应时间    42.10ms   98.36ms   2.00s   98.33%</span><br><span class="line">    请求&#x2F;秒     1.06k   284.48     4.20k   74.23%</span><br><span class="line">  响应时间分布：</span><br><span class="line">     50%   26.65ms   50% 在26.65毫秒完成</span><br><span class="line">     75%   41.39ms   75% 在41.39毫秒完成</span><br><span class="line">     90%   62.64ms   90% 在62.64毫秒完成</span><br><span class="line">     99%  374.95ms   99% 在374.95毫秒完成</span><br><span class="line">  30.07s 共发送 376093 个请求, 共读取 60.62MB 数据</span><br><span class="line">  Socket 错误: 连接 0, 读 0, 写 0, 超市 81</span><br><span class="line">请求&#x2F;秒:  12508.83</span><br><span class="line">获取数据&#x2F;s:  2.02MB</span><br></pre></td></tr></table></figure>

<h2 id="Lua脚本的使用"><a href="#Lua脚本的使用" class="headerlink" title="Lua脚本的使用"></a>Lua脚本的使用</h2><p>POST + header + body</p>
<p>编写Lua脚本</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wrk.method = <span class="string">&quot;POST&quot;</span>  </span><br><span class="line">wrk.body   = <span class="string">&quot;foo=bar&amp;baz=quux&quot;</span>  </span><br><span class="line">wrk.headers[<span class="string">&quot;Content-Type&quot;</span>] = <span class="string">&quot;application/x-www-form-urlencoded&quot;</span></span><br></pre></td></tr></table></figure>

<p>使用wrk加载脚本并执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wrk -t12 -c400 -d30s --latency --script=post.lua --latency http://127.0.0.1:8000</span><br></pre></td></tr></table></figure>

<p>wrk 对象的修改全局只会执行一次</p>
<p>wrk的全局对象如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">local wrk &#x3D; &#123;</span><br><span class="line">   scheme  &#x3D; &quot;http&quot;,</span><br><span class="line">   host    &#x3D; &quot;localhost&quot;,</span><br><span class="line">   port    &#x3D; nil,</span><br><span class="line">   method  &#x3D; &quot;GET&quot;,</span><br><span class="line">   path    &#x3D; &quot;&#x2F;&quot;,</span><br><span class="line">   headers &#x3D; &#123;&#125;,</span><br><span class="line">   body    &#x3D; nil,</span><br><span class="line">   thread  &#x3D; nil,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="用-lua-脚本测试复杂场景"><a href="#用-lua-脚本测试复杂场景" class="headerlink" title="用 lua 脚本测试复杂场景"></a>用 lua 脚本测试复杂场景</h2><p>wrk 提供了几个 hook 函数，可以用 lua 来编写一些复杂场景下的测试：</p>
<h3 id="setup"><a href="#setup" class="headerlink" title="setup"></a>setup</h3><p>这个函数在目标 IP 地址已经解析完，并且所有 thread 已经生成，但是还没有开始时被调用，每个线程执行一次这个函数。可以通过 thread:get(name)， thread:set(name, value) 设置线程级别的变量。</p>
<h3 id="init"><a href="#init" class="headerlink" title="init"></a>init</h3><p>每次请求发送之前被调用。可以接受 wrk 命令行的额外参数，通过 – 指定。</p>
<h3 id="delay"><a href="#delay" class="headerlink" title="delay"></a>delay</h3><p>这个函数返回一个数值，在这次请求执行完以后延迟多长时间执行下一个请求，可以对应 thinking time 的场景。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- example script that demonstrates adding a random</span></span><br><span class="line"><span class="comment">-- 10-50ms delay before each request</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">delay</span><span class="params">()</span></span></span><br><span class="line">   <span class="keyword">return</span> <span class="built_in">math</span>.<span class="built_in">random</span>(<span class="number">10</span>, <span class="number">50</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="request"><a href="#request" class="headerlink" title="request"></a>request</h3><p>通过这个函数可以每次请求之前修改本次请求的属性，返回一个字符串，这个函数要慎用， 会影响测试端性能。</p>
<h3 id="response"><a href="#response" class="headerlink" title="response"></a>response</h3><p>每次请求返回以后被调用，可以根据响应内容做特殊处理，比如遇到特殊响应停止执行测试，或输出到控制台等等。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">response</span><span class="params">(status, headers, body)</span></span>  </span><br><span class="line">   <span class="keyword">if</span> <span class="built_in">status</span> ~= <span class="number">200</span> <span class="keyword">then</span>  </span><br><span class="line">      <span class="built_in">print</span>(body)  </span><br><span class="line">      wrk.thread:stop()  </span><br><span class="line">   <span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">end</span>  </span><br></pre></td></tr></table></figure>

<h3 id="done"><a href="#done" class="headerlink" title="done"></a>done</h3><p>在所有请求执行完以后调用, 一般用于自定义统计结果</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">done = <span class="function"><span class="keyword">function</span><span class="params">(summary, latency, requests)</span></span>  </span><br><span class="line">   <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;------------------------------\n&quot;</span>)  </span><br><span class="line">   <span class="keyword">for</span> _, p <span class="keyword">in</span> <span class="built_in">pairs</span>(&#123; <span class="number">50</span>, <span class="number">90</span>, <span class="number">99</span>, <span class="number">99.999</span> &#125;) <span class="keyword">do</span>  </span><br><span class="line">      n = latency:percentile(p)  </span><br><span class="line">      <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%g%%,%d\n&quot;</span>, p, n))  </span><br><span class="line">   <span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">end</span>  </span><br></pre></td></tr></table></figure>

<h2 id="Lua例子"><a href="#Lua例子" class="headerlink" title="Lua例子"></a>Lua例子</h2><p>下面是 wrk 源代码中给出的完整例子: </p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> counter = <span class="number">1</span>  </span><br><span class="line"><span class="keyword">local</span> threads = &#123;&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setup</span><span class="params">(thread)</span></span>  </span><br><span class="line">   thread:set(<span class="string">&quot;id&quot;</span>, counter)  </span><br><span class="line">   <span class="built_in">table</span>.<span class="built_in">insert</span>(threads, thread)  </span><br><span class="line">   counter = counter + <span class="number">1</span>  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">(args)</span></span>  </span><br><span class="line">   requests  = <span class="number">0</span>  </span><br><span class="line">   responses = <span class="number">0</span>  </span><br><span class="line">  </span><br><span class="line">   <span class="keyword">local</span> msg = <span class="string">&quot;thread %d created&quot;</span>  </span><br><span class="line">   <span class="built_in">print</span>(msg:<span class="built_in">format</span>(id))  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">request</span><span class="params">()</span></span>  </span><br><span class="line">   requests = requests + <span class="number">1</span>  </span><br><span class="line">   <span class="keyword">return</span> wrk.request()  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">response</span><span class="params">(status, headers, body)</span></span>  </span><br><span class="line">   responses = responses + <span class="number">1</span>  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">done</span><span class="params">(summary, latency, requests)</span></span>  </span><br><span class="line">   <span class="keyword">for</span> index, thread <span class="keyword">in</span> <span class="built_in">ipairs</span>(threads) <span class="keyword">do</span>  </span><br><span class="line">      <span class="keyword">local</span> id        = thread:get(<span class="string">&quot;id&quot;</span>)  </span><br><span class="line">      <span class="keyword">local</span> requests  = thread:get(<span class="string">&quot;requests&quot;</span>)  </span><br><span class="line">      <span class="keyword">local</span> responses = thread:get(<span class="string">&quot;responses&quot;</span>)  </span><br><span class="line">      <span class="keyword">local</span> msg = <span class="string">&quot;thread %d made %d requests and got %d responses&quot;</span>  </span><br><span class="line">      <span class="built_in">print</span>(msg:<span class="built_in">format</span>(id, requests, responses))  </span><br><span class="line">   <span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">end</span>  </span><br></pre></td></tr></table></figure>


<h3 id="测试复合场景"><a href="#测试复合场景" class="headerlink" title="测试复合场景"></a>测试复合场景</h3><p>可以通过 lua 实现访问多个 url.<br>例如这个复杂的 lua 脚本, 随机读取 paths.txt 文件中的 url 列表, 然后访问</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">counter = <span class="number">1</span>  </span><br><span class="line">  </span><br><span class="line"><span class="built_in">math</span>.<span class="built_in">randomseed</span>(<span class="built_in">os</span>.<span class="built_in">time</span>())  </span><br><span class="line"><span class="built_in">math</span>.<span class="built_in">random</span>(); <span class="built_in">math</span>.<span class="built_in">random</span>(); <span class="built_in">math</span>.<span class="built_in">random</span>()  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">file_exists</span><span class="params">(file)</span></span>  </span><br><span class="line">  <span class="keyword">local</span> f = <span class="built_in">io</span>.<span class="built_in">open</span>(file, <span class="string">&quot;rb&quot;</span>)  </span><br><span class="line">  <span class="keyword">if</span> f <span class="keyword">then</span> f:<span class="built_in">close</span>() <span class="keyword">end</span>  </span><br><span class="line">  <span class="keyword">return</span> f ~= <span class="literal">nil</span>  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shuffle</span><span class="params">(paths)</span></span>  </span><br><span class="line">  <span class="keyword">local</span> j, k  </span><br><span class="line">  <span class="keyword">local</span> n = #paths  </span><br><span class="line">  <span class="keyword">for</span> i = <span class="number">1</span>, n <span class="keyword">do</span>  </span><br><span class="line">    j, k = <span class="built_in">math</span>.<span class="built_in">random</span>(n), <span class="built_in">math</span>.<span class="built_in">random</span>(n)  </span><br><span class="line">    paths[j], paths[k] = paths[k], paths[j]  </span><br><span class="line">  <span class="keyword">end</span>  </span><br><span class="line">  <span class="keyword">return</span> paths  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">non_empty_lines_from</span><span class="params">(file)</span></span>  </span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> file_exists(file) <span class="keyword">then</span> <span class="keyword">return</span> &#123;&#125; <span class="keyword">end</span>  </span><br><span class="line">  <span class="built_in">lines</span> = &#123;&#125;  </span><br><span class="line">  <span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">io</span>.<span class="built_in">lines</span>(file) <span class="keyword">do</span>  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (line == <span class="string">&#x27;&#x27;</span>) <span class="keyword">then</span>  </span><br><span class="line">      <span class="built_in">lines</span>[#<span class="built_in">lines</span> + <span class="number">1</span>] = line  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">  <span class="keyword">end</span>  </span><br><span class="line">  <span class="keyword">return</span> shuffle(<span class="built_in">lines</span>)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line">paths = non_empty_lines_from(<span class="string">&quot;paths.txt&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> #paths &lt;= <span class="number">0</span> <span class="keyword">then</span>  </span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;multiplepaths: No paths found. You have to create a file paths.txt with one path per line&quot;</span>)  </span><br><span class="line">  <span class="built_in">os</span>.<span class="built_in">exit</span>()  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;multiplepaths: Found &quot;</span> .. #paths .. <span class="string">&quot; paths&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">request = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>  </span><br><span class="line">    <span class="built_in">path</span> = paths[counter]  </span><br><span class="line">    counter = counter + <span class="number">1</span>  </span><br><span class="line">    <span class="keyword">if</span> counter &gt; #paths <span class="keyword">then</span>  </span><br><span class="line">      counter = <span class="number">1</span>  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    <span class="keyword">return</span> wrk.<span class="built_in">format</span>(<span class="literal">nil</span>, <span class="built_in">path</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="关于-cookie"><a href="#关于-cookie" class="headerlink" title="关于 cookie"></a>关于 cookie</h3><p>有些时候我们需要模拟一些通过 cookie 传递数据的场景. wrk 并没有特殊支持, 可以通过 wrk.headers[“Cookie”]=”xxxxx”实现.<br>下面是在网上找的一个例子, 取 Response的cookie作为后续请求的cookie </p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCookie</span><span class="params">(cookies, name)</span></span>  </span><br><span class="line">  <span class="keyword">local</span> start = <span class="built_in">string</span>.<span class="built_in">find</span>(cookies, name .. <span class="string">&quot;=&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> start == <span class="literal">nil</span> <span class="keyword">then</span>  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>  </span><br><span class="line">  <span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">string</span>.<span class="built_in">sub</span>(cookies, start + #name + <span class="number">1</span>, <span class="built_in">string</span>.<span class="built_in">find</span>(cookies, <span class="string">&quot;;&quot;</span>, start) - <span class="number">1</span>)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line">response = <span class="function"><span class="keyword">function</span><span class="params">(status, headers, body)</span></span>  </span><br><span class="line">  <span class="keyword">local</span> token = getCookie(headers[<span class="string">&quot;Set-Cookie&quot;</span>], <span class="string">&quot;token&quot;</span>)  </span><br><span class="line">    </span><br><span class="line">  <span class="keyword">if</span> token ~= <span class="literal">nil</span> <span class="keyword">then</span>  </span><br><span class="line">    wrk.headers[<span class="string">&quot;Cookie&quot;</span>] = <span class="string">&quot;token=&quot;</span> .. token  </span><br><span class="line">  <span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">end</span>  </span><br></pre></td></tr></table></figure>


<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>wrk 本身的定位不是用来替换 loadrunner 这样的专业性能测试工具的. 其实有这些功能已经完全能应付平时开发过程中的一些性能验证了.</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/linux/" rel="tag"># linux</a>
              <a href="/tags/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/" rel="tag"># 性能测试</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/12/15/cut/" rel="prev" title="cut 使用详解">
      <i class="fa fa-chevron-left"></i> cut 使用详解
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/03/05/node-load-balance/" rel="next" title="nodejs 服务单机三种负载均衡实现方式">
      nodejs 服务单机三种负载均衡实现方式 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">1.</span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#mac"><span class="nav-number">1.1.</span> <span class="nav-text">mac</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ubuntu-Debian-clean-box"><span class="nav-number">1.2.</span> <span class="nav-text">Ubuntu&#x2F;Debian (clean box)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CentOS-RedHat-Fedora"><span class="nav-number">1.3.</span> <span class="nav-text">CentOS &#x2F; RedHat &#x2F; Fedora</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E5%8F%82%E6%95%B0"><span class="nav-number">2.</span> <span class="nav-text">命令参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-number">3.</span> <span class="nav-text">使用方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lua%E8%84%9A%E6%9C%AC%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">4.</span> <span class="nav-text">Lua脚本的使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8-lua-%E8%84%9A%E6%9C%AC%E6%B5%8B%E8%AF%95%E5%A4%8D%E6%9D%82%E5%9C%BA%E6%99%AF"><span class="nav-number">5.</span> <span class="nav-text">用 lua 脚本测试复杂场景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#setup"><span class="nav-number">5.1.</span> <span class="nav-text">setup</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#init"><span class="nav-number">5.2.</span> <span class="nav-text">init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#delay"><span class="nav-number">5.3.</span> <span class="nav-text">delay</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#request"><span class="nav-number">5.4.</span> <span class="nav-text">request</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#response"><span class="nav-number">5.5.</span> <span class="nav-text">response</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#done"><span class="nav-number">5.6.</span> <span class="nav-text">done</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lua%E4%BE%8B%E5%AD%90"><span class="nav-number">6.</span> <span class="nav-text">Lua例子</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E5%A4%8D%E5%90%88%E5%9C%BA%E6%99%AF"><span class="nav-number">6.1.</span> <span class="nav-text">测试复合场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E-cookie"><span class="nav-number">6.2.</span> <span class="nav-text">关于 cookie</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">7.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Micjoyce"
      src="/uploads/avatar.png">
  <p class="site-author-name" itemprop="name">Micjoyce</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">15</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/micjoyce" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;micjoyce" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:micjoyce90@gmail.com" title="E-Mail → mailto:micjoyce90@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://micjoyce.com/" title="https:&#x2F;&#x2F;micjoyce.com" rel="noopener" target="_blank">Title</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Micjoyce</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v5.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.6.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://micjoyce.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "https://www.micjoyce.com/2019/02/03/wrk/",
            identifier: "2019/02/03/wrk/",
            title: "如何使用 wrk 进行性能压测"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://micjoyce.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
